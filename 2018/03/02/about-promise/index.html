<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="ç¿»è¯‘,JavaScript,Promise," />








  <link rel="shortcut icon" type="image/x-icon" href="http://oux6kzfrp.bkt.clouddn.com/aoteman.jpg?v=5.1.2" />






<meta name="description" content="åŸæ–‡åœ°å€ï¼š9 Promising Promise Tips åŸæ–‡ä½œè€…ï¼šKushan Joshi è¯‘æ–‡å‡ºè‡ªï¼šæ˜é‡‘ç¿»è¯‘è®¡åˆ’ æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼šhttps://github.com/xitu/gold-miner/blob/master/TODO/promising-promise-tips.md è¯‘è€…ï¼šposition_æŸšå­å› æ ¡å¯¹è€…ï¼šStarrier, DukeWu   å…³äº Promise çš„ 9">
<meta name="keywords" content="ç¿»è¯‘,JavaScript,Promise">
<meta property="og:type" content="article">
<meta property="og:title" content="å…³äº Promise çš„ 9 ä¸ªæç¤º">
<meta property="og:url" content="http://yanmeng.me/2018/03/02/about-promise/index.html">
<meta property="og:site_name" content="position_æŸšå­å›">
<meta property="og:description" content="åŸæ–‡åœ°å€ï¼š9 Promising Promise Tips åŸæ–‡ä½œè€…ï¼šKushan Joshi è¯‘æ–‡å‡ºè‡ªï¼šæ˜é‡‘ç¿»è¯‘è®¡åˆ’ æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼šhttps://github.com/xitu/gold-miner/blob/master/TODO/promising-promise-tips.md è¯‘è€…ï¼šposition_æŸšå­å› æ ¡å¯¹è€…ï¼šStarrier, DukeWu   å…³äº Promise çš„ 9">
<meta property="og:image" content="https://res.cloudinary.com/practicaldev/image/fetch/s--zlauxVhZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36483828-3e361d88-16e5-11e8-9f11-cbe99d719066.png">
<meta property="og:image" content="https://res.cloudinary.com/practicaldev/image/fetch/s--gf5-9vXv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36400725-dac92186-15a0-11e8-8b4f-6a344e6a5229.png">
<meta property="og:updated_time" content="2018-03-02T14:35:03.291Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="å…³äº Promise çš„ 9 ä¸ªæç¤º">
<meta name="twitter:description" content="åŸæ–‡åœ°å€ï¼š9 Promising Promise Tips åŸæ–‡ä½œè€…ï¼šKushan Joshi è¯‘æ–‡å‡ºè‡ªï¼šæ˜é‡‘ç¿»è¯‘è®¡åˆ’ æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼šhttps://github.com/xitu/gold-miner/blob/master/TODO/promising-promise-tips.md è¯‘è€…ï¼šposition_æŸšå­å› æ ¡å¯¹è€…ï¼šStarrier, DukeWu   å…³äº Promise çš„ 9">
<meta name="twitter:image" content="https://res.cloudinary.com/practicaldev/image/fetch/s--zlauxVhZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36483828-3e361d88-16e5-11e8-9f11-cbe99d719066.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yanmeng.me/2018/03/02/about-promise/"/>





  <title>å…³äº Promise çš„ 9 ä¸ªæç¤º | position_æŸšå­å›</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f504c7f6160a763bcac725ebe10164ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">position_æŸšå­å›</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yanmeng.me/2018/03/02/about-promise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Meng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oux6kzfrp.bkt.clouddn.com/blog/avatarIMG_3716.JPG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="position_æŸšå­å›">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">å…³äº Promise çš„ 9 ä¸ªæç¤º</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2018-03-02T22:31:36+08:00">
                2018-03-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/03/02/about-promise/" class="leancloud_visitors" data-flag-title="å…³äº Promise çš„ 9 ä¸ªæç¤º">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o">æœ¬æ–‡æ€»é˜…è¯»é‡</i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>æ¬¡
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<ul>
<li>åŸæ–‡åœ°å€ï¼š<a href="https://dev.to/kepta/promising-promise-tips--c8f" target="_blank" rel="external">9 Promising Promise Tips</a></li>
<li>åŸæ–‡ä½œè€…ï¼š<a href="https://dev.to/kepta" target="_blank" rel="external">Kushan Joshi</a></li>
<li>è¯‘æ–‡å‡ºè‡ªï¼š<a href="https://github.com/xitu/gold-miner" target="_blank" rel="external">æ˜é‡‘ç¿»è¯‘è®¡åˆ’</a></li>
<li>æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š<a href="https://github.com/xitu/gold-miner/blob/master/TODO/promising-promise-tips.md" target="_blank" rel="external">https://github.com/xitu/gold-miner/blob/master/TODO/promising-promise-tips.md</a></li>
<li>è¯‘è€…ï¼š<a href="https://github.com/yanyixin" target="_blank" rel="external">position_æŸšå­å›</a></li>
<li>æ ¡å¯¹è€…ï¼š<a href="https://github.com/Starriers" target="_blank" rel="external">Starrier</a>, <a href="https://github.com/94haox" target="_blank" rel="external">DukeWu</a></li>
</ul>
</blockquote>
<h1 id="å…³äº-Promise-çš„-9-ä¸ªæç¤º"><a href="#å…³äº-Promise-çš„-9-ä¸ªæç¤º" class="headerlink" title="å…³äº Promise çš„ 9 ä¸ªæç¤º"></a>å…³äº Promise çš„ 9 ä¸ªæç¤º</h1><p>æ­£å¦‚åŒäº‹æ‰€è¯´çš„é‚£æ ·ï¼ŒPromise åœ¨å·¥ä½œä¸­è¡¨ç°ä¼˜å¼‚ã€‚</p>
<p><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--zlauxVhZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36483828-3e361d88-16e5-11e8-9f11-cbe99d719066.png" alt="prom"></p>
<p>è¿™ç¯‡æ–‡ç« ä¼šç»™ä½ ä¸€äº›å¦‚ä½•æ”¹å–„ä¸ Promise ä¹‹é—´å…³ç³»çš„å»ºè®®ã€‚</p>
<a id="more"></a>
<h2 id="1-ä½ å¯ä»¥åœ¨-then-é‡Œé¢-return-ä¸€ä¸ª-Promise"><a href="#1-ä½ å¯ä»¥åœ¨-then-é‡Œé¢-return-ä¸€ä¸ª-Promise" class="headerlink" title="1. ä½ å¯ä»¥åœ¨ .then é‡Œé¢ return ä¸€ä¸ª Promise"></a>1. ä½ å¯ä»¥åœ¨ .then é‡Œé¢ return ä¸€ä¸ª Promise</h2><p>è®©æˆ‘æ¥è¯´æ˜è¿™æœ€é‡è¦çš„ä¸€ç‚¹</p>
<blockquote>
<p><strong>æ˜¯çš„ï¼ä½ å¯ä»¥åœ¨ .then é‡Œé¢ return ä¸€ä¸ª Promise</strong></p>
</blockquote>
<p>è€Œä¸”ï¼Œreturn çš„è¿™ä¸ª Promise å°†åœ¨ä¸‹ä¸€ä¸ª <code>.then</code> ä¸­è‡ªåŠ¨è§£æã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">.then(r =&gt; &#123;</div><div class="line">    return serverStatusPromise(r); // è¿”å› &#123; statusCode: 200 &#125; çš„ Promise</div><div class="line">&#125;)</div><div class="line">.then(resp =&gt; &#123;</div><div class="line">    console.log(resp.statusCode); // 200; æ³¨æ„è‡ªåŠ¨è§£æçš„ promise</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="2-æ¯æ¬¡æ‰§è¡Œ-then-çš„æ—¶å€™éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„-Promise"><a href="#2-æ¯æ¬¡æ‰§è¡Œ-then-çš„æ—¶å€™éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„-Promise" class="headerlink" title="2. æ¯æ¬¡æ‰§è¡Œ .then çš„æ—¶å€™éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ Promise"></a>2. æ¯æ¬¡æ‰§è¡Œ .then çš„æ—¶å€™éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ Promise</h2><p>å¦‚æœç†Ÿæ‚‰ javascript çš„é“¾å¼é£æ ¼ï¼Œé‚£ä¹ˆä½ åº”è¯¥ä¼šæ„Ÿåˆ°å¾ˆç†Ÿæ‚‰ã€‚ä½†æ˜¯å¯¹äºä¸€ä¸ªåˆå­¦è€…æ¥è¯´ï¼Œå¯èƒ½å°±ä¸ä¼šäº†ã€‚</p>
<p>åœ¨ Promise ä¸­ä¸è®ºä½ ä½¿ç”¨ <code>.then</code> æˆ–è€… <code>.catch</code> éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Promiseã€‚è¿™ä¸ª Promise æ˜¯åˆšåˆšé“¾å¼è°ƒç”¨çš„ Promise å’Œ åˆšåˆšåŠ ä¸Šçš„ <code>.then</code> / <code>.catch</code> çš„ç»„åˆã€‚</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª ğŸŒ°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">var statusProm = fetchServerStatus();</div><div class="line"></div><div class="line">var promA = statusProm.then(r =&gt; (r.statusCode === 200 ? &quot;good&quot; : &quot;bad&quot;));</div><div class="line"></div><div class="line">var promB = promA.then(r =&gt; (r === &quot;good&quot; ? &quot;ALL OK&quot; : &quot;NOTOK&quot;));</div><div class="line"></div><div class="line">var promC = statusProm.then(r =&gt; fetchThisAnotherThing());</div></pre></td></tr></table></figure>
<p>ä¸Šé¢ Promise çš„å…³ç³»å¯ä»¥åœ¨æµç¨‹å›¾ä¸­æ¸…æ™°çš„æè¿°å‡ºæ¥ï¼š<br><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--gf5-9vXv--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6966254/36400725-dac92186-15a0-11e8-8b4f-6a344e6a5229.png" alt="image"></p>
<p>éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ <code>promA</code>ã€ <code>promB</code> å’Œ <code>promC</code> å…¨éƒ¨éƒ½æ˜¯ä¸åŒçš„ä½†æ˜¯æœ‰å…³è”çš„ Promiseã€‚</p>
<p>æˆ‘å–œæ¬¢æŠŠ <code>.then</code> æƒ³åƒæˆä¸€ä¸ªå¤§å‹ç®¡é“ï¼Œå½“ä¸Šæ¸¸èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ï¼Œæ°´å°±ä¼šåœæ­¢æµå‘ä¸‹æ¸¸ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ <code>promB</code> å¤±è´¥ï¼Œä¸‹æ¸¸èŠ‚ç‚¹ä¸ä¼šå—åˆ°å½±å“ï¼Œä½†æ˜¯å¦‚æœ <code>statusProm</code> å¤±è´¥ï¼Œé‚£ä¹ˆä¸‹æ¸¸çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å°†å—åˆ°å½±å“ï¼Œå³ <code>rejected</code>ã€‚</p>
<h2 id="3-å¯¹è°ƒç”¨è€…æ¥è¯´ï¼ŒPromise-çš„-resolved-rejected-çŠ¶æ€æ˜¯å”¯ä¸€çš„"><a href="#3-å¯¹è°ƒç”¨è€…æ¥è¯´ï¼ŒPromise-çš„-resolved-rejected-çŠ¶æ€æ˜¯å”¯ä¸€çš„" class="headerlink" title="3. å¯¹è°ƒç”¨è€…æ¥è¯´ï¼ŒPromise çš„ resolved/rejected çŠ¶æ€æ˜¯å”¯ä¸€çš„"></a>3. å¯¹è°ƒç”¨è€…æ¥è¯´ï¼Œ<code>Promise</code> çš„ <code>resolved/rejected</code> çŠ¶æ€æ˜¯å”¯ä¸€çš„</h2><p>æˆ‘è®¤ä¸ºè¿™ä¸ªæ˜¯è®© Promise å¥½å¥½è¿è¡Œçš„æœ€é‡è¦çš„äº‹æƒ…ä¹‹ä¸€ã€‚ç®€å•æ¥è¯´ï¼Œå¦‚æœåœ¨ä½ çš„åº”ç”¨ä¸­ Promise åœ¨å¾ˆå¤šä¸åŒçš„æ¨¡å—ä¹‹é—´å…±äº«ï¼Œé‚£ä¹ˆå½“ Promise è¿”å› <code>resolved/rejected</code> çŠ¶æ€æ—¶ï¼Œæ‰€æœ‰çš„è°ƒç”¨è€…éƒ½ä¼šæ”¶åˆ°é€šçŸ¥ã€‚</p>
<blockquote>
<p>è¿™ä¹Ÿæ„å‘³ç€æ²¡æœ‰äººå¯ä»¥æ”¹å˜ä½ çš„ Promiseï¼Œæ‰€ä»¥å¯ä»¥æ”¾å¿ƒçš„æŠŠå®ƒä¼ é€’å‡ºå»ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">function yourFunc() &#123;</div><div class="line">  const yourAwesomeProm = makeMeProm();</div><div class="line"></div><div class="line">  yourEvilUncle(yourAwesomeProm); // æ— è®º Promise å—åˆ°äº†æ€æ ·çš„å½±å“ï¼Œå®ƒæœ€ç»ˆéƒ½ä¼šæˆåŠŸæ‰§è¡Œ</div><div class="line"></div><div class="line">  return yourAwesomeProm.then(r =&gt; importantProcessing(r));</div><div class="line">&#125;</div><div class="line"></div><div class="line">function yourEvilUncle(prom) &#123;</div><div class="line">  return prom.then(r =&gt; Promise.reject(&quot;destroy!!&quot;)); // å¯èƒ½é­å—çš„å½±å“</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼ŒPromise çš„è®¾è®¡ä½¿å¾—è‡ªèº«å¾ˆéš¾è¢«æ”¹å˜ã€‚æ­£å¦‚æˆ‘ä¸Šé¢æ‰€è¯´çš„ï¼šâ€ä¿æŒå†·é™ï¼Œå¹¶å°† Promise ä¼ é€’ä¸‹å»â€ã€‚</p>
<h2 id="4-Promise-æ„é€ å‡½æ•°ä¸æ˜¯è§£å†³æ–¹æ¡ˆ"><a href="#4-Promise-æ„é€ å‡½æ•°ä¸æ˜¯è§£å†³æ–¹æ¡ˆ" class="headerlink" title="4. Promise æ„é€ å‡½æ•°ä¸æ˜¯è§£å†³æ–¹æ¡ˆ"></a>4. Promise æ„é€ å‡½æ•°ä¸æ˜¯è§£å†³æ–¹æ¡ˆ</h2><p>æˆ‘çœ‹åˆ°å¾ˆå¤šå¼€å‘è€…å–œæ¬¢ç”¨æ„é€ å‡½æ•°çš„é£æ ¼ï¼Œä»–ä»¬è®¤ä¸ºè¿™å°±æ˜¯ Promise çš„æ–¹å¼ã€‚ä½†è¿™å´æ˜¯ä¸€ä¸ªè°è¨€ï¼Œå®é™…çš„åŸå› æ˜¯æ„é€ å‡½æ•° API å’Œä¹‹å‰å›è°ƒå‡½æ•°çš„ API ç›¸ä¼¼ï¼Œè€Œä¸”è¿™æ ·çš„ä¹ æƒ¯å¾ˆéš¾æ”¹å˜ã€‚</p>
<blockquote>
<p><strong>å¦‚æœä½ å‘ç°è‡ªå·±æ­£åœ¨åˆ°å¤„ä½¿ç”¨ <code>Promise æ„é€ å‡½æ•°</code>ï¼Œé‚£ä½ çš„åšæ³•æ˜¯é”™çš„ï¼</strong></p>
</blockquote>
<p>è¦çœŸæ­£çš„å‘å‰è¿ˆè¿›ä¸€æ­¥å¹¶ä¸”æ‘†è„±å›è°ƒï¼Œä½ éœ€è¦å°å¿ƒè°¨æ…å¹¶ä¸”æœ€å°ç¨‹åº¦åœ°ä½¿ç”¨ Promise æ„é€ å‡½æ•°ã€‚</p>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä½¿ç”¨ <code>Promise æ„é€ å‡½æ•°</code> çš„å…·ä½“æƒ…å†µï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">return new Promise((res, rej) =&gt; &#123;</div><div class="line">  fs.readFile(&quot;/etc/passwd&quot;, function(err, data) &#123;</div><div class="line">    if (err) return rej(err);</div><div class="line">    return res(data);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>Promise æ„é€ å‡½æ•°</code> åº”è¯¥<strong>åªåœ¨ä½ æƒ³è¦æŠŠå›è°ƒè½¬æ¢æˆ Promise æ—¶ä½¿ç”¨</strong>ã€‚<br>ä¸€æ—¦ä½ æŒæ¡äº†è¿™ç§åˆ›å»º Promise çš„ä¼˜é›…æ–¹å¼ï¼Œå®ƒå°†ä¼šå˜çš„éå¸¸æœ‰å¸å¼•åŠ›ã€‚</p>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å†—ä½™çš„ <code>Promise æ„é€ å‡½æ•°</code>ã€‚</p>
<p>â˜ ï¸<strong>é”™è¯¯çš„</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">return new Promise((res, rej) =&gt; &#123;</div><div class="line">    var fetchPromise = fetchSomeData(.....);</div><div class="line">    fetchPromise</div><div class="line">        .then(data =&gt; &#123;</div><div class="line">            res(data); // é”™è¯¯ï¼ï¼ï¼</div><div class="line">        &#125;)</div><div class="line">        .catch(err =&gt; rej(err))</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>ğŸ’–<strong>æ­£ç¡®çš„</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">return fetchSomeData(...); // æ­£ç¡®çš„ï¼</div></pre></td></tr></table></figure>
<p>ç”¨ <code>Promise æ„é€ å‡½æ•°</code> å°è£… Promise æ˜¯<strong>å¤šä½™çš„ï¼Œå¹¶ä¸”è¿èƒŒäº† Promise æœ¬èº«çš„ç›®çš„</strong>ã€‚</p>
<p>ğŸ˜<strong>é«˜çº§æŠ€å·§</strong></p>
<p>å¦‚æœä½ æ˜¯ä¸€ä¸ª <strong>nodejs</strong> å¼€å‘è€…ï¼Œæˆ‘å»ºè®®ä½ å¯ä»¥çœ‹ä¸€çœ‹ <a href="http://2ality.com/2017/05/util-promisify.html" target="_blank" rel="external">util.promisify</a>ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥å¸®åŠ©ä½ æŠŠ node é£æ ¼çš„å›è°ƒè½¬æ¢ä¸º Promiseã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">const &#123;promisify&#125; = require(&apos;util&apos;);</div><div class="line">const fs = require(&apos;fs&apos;);</div><div class="line"></div><div class="line">const readFileAsync = promisify(fs.readFile);</div><div class="line"></div><div class="line">readFileAsync(&apos;myfile.txt&apos;, &apos;utf-8&apos;)</div><div class="line">  .then(r =&gt; console.log(r))</div><div class="line">  .catch(e =&gt; console.error(e));</div></pre></td></tr></table></figure>
<p></p>
<h2 id="5-ä½¿ç”¨-Promise-resolve"><a href="#5-ä½¿ç”¨-Promise-resolve" class="headerlink" title="5. ä½¿ç”¨ Promise.resolve"></a>5. ä½¿ç”¨ Promise.resolve</h2><p>Javascript æä¾›äº† <code>Promise.resolve</code> æ–¹æ³•ï¼Œåƒä¸‹é¢çš„ä¾‹å­è¿™æ ·ç®€æ´ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">var similarProm = new Promise(res =&gt; res(5));</div><div class="line">// ^^ ç­‰ä»·äº</div><div class="line">var prom = Promise.resolve(5);</div></pre></td></tr></table></figure>
<p>å®ƒæœ‰å¤šç§ä½¿ç”¨æƒ…å†µï¼Œæˆ‘æœ€å–œæ¬¢çš„ä¸€ç§æ˜¯å¯ä»¥æŠŠæ™®é€šçš„ï¼ˆå¼‚æ­¥çš„ï¼‰js å¯¹è±¡è½¬åŒ–æˆ Promiseã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// å°†åŒæ­¥å‡½æ•°è½¬æ¢ä¸ºå¼‚æ­¥å‡½æ•°</div><div class="line">function foo() &#123;</div><div class="line">  return Promise.resolve(5);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“ä¸ç¡®å®šå®ƒæ˜¯ä¸€ä¸ª Promise è¿˜æ˜¯ä¸€ä¸ªæ™®é€šçš„å€¼çš„æ—¶å€™ï¼Œä½ ä¹Ÿå¯ä»¥åšä¸€ä¸ªå®‰å…¨çš„å°è£…ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">function goodProm(maybePromise) &#123;</div><div class="line">  return Promise.resolve(maybePromise);</div><div class="line">&#125;</div><div class="line"></div><div class="line">goodProm(5).then(console.log); // 5</div><div class="line"></div><div class="line">var sixPromise = fetchMeNumber(6);</div><div class="line"></div><div class="line">goodProm(sixPromise).then(console.log); // 6</div><div class="line"></div><div class="line">goodProm(Promise.resolve(Promise.resolve(5))).then(console.log); // 5, æ³¨æ„ï¼Œå®ƒä¼šè‡ªåŠ¨è§£ææ‰€æœ‰çš„ Promiseï¼</div></pre></td></tr></table></figure>
<h2 id="6-ä½¿ç”¨-Promise-reject"><a href="#6-ä½¿ç”¨-Promise-reject" class="headerlink" title="6.ä½¿ç”¨ Promise.reject"></a>6.ä½¿ç”¨ Promise.reject</h2><p>Javascript ä¹Ÿæä¾›äº† <code>Promise.reject</code> æ–¹æ³•ã€‚åƒä¸‹é¢çš„ä¾‹å­è¿™æ ·ç®€æ´ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">var rejProm = new Promise((res, reject) =&gt; reject(5));</div><div class="line"></div><div class="line">rejProm.catch(e =&gt; console.log(e)) // 5</div></pre></td></tr></table></figure>
<p>æˆ‘æœ€å–œæ¬¢çš„ç”¨æ³•æ˜¯æå‰ä½¿ç”¨ <code>Promise.reject</code> æ¥æ‹’ç»ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">function foo(myVal) &#123;</div><div class="line">    if (!mVal) &#123;</div><div class="line">        return Promise.reject(new Error(&apos;myVal is required&apos;))</div><div class="line">    &#125;</div><div class="line">    return new Promise((res, rej) =&gt; &#123;</div><div class="line">        // ä»ä½ çš„å¤§å›è°ƒåˆ° Promise çš„è½¬æ¢ï¼</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç®€å•æ¥è¯´ï¼Œä½¿ç”¨ <code>Promise.reject</code> å¯ä»¥æ‹’ç»ä»»ä½•ä½ æƒ³è¦æ‹’ç»çš„ Promiseã€‚</p>
<p>åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘åœ¨ <code>.then</code> é‡Œé¢ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">.then(val =&gt; &#123;</div><div class="line">  if (val != 5) &#123;</div><div class="line">    return Promise.reject(&apos;Not Good&apos;);</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line">.catch(e =&gt; console.log(e)) // è¿™æ ·æ˜¯ä¸å¥½çš„</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼šä½ å¯ä»¥åƒ <code>Promise.resolve</code> ä¸€æ ·åœ¨ <code>Promise.reject</code> ä¸­ä¼ é€’ä»»ä½•å€¼ã€‚ä½ ç»å¸¸åœ¨å¤±è´¥çš„ Promise ä¸­å‘ç° <code>Error</code> çš„åŸå› æ˜¯å› ä¸ºå®ƒä¸»è¦å°±æ˜¯ç”¨æ¥æŠ›å‡ºä¸€ä¸ªå¼‚æ­¥é”™è¯¯çš„ã€‚</strong></p>
<h2 id="7-ä½¿ç”¨-Promise-all"><a href="#7-ä½¿ç”¨-Promise-all" class="headerlink" title="7. ä½¿ç”¨ Promise.all"></a>7. ä½¿ç”¨ Promise.all</h2><p>Javascript æä¾›äº† <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all" target="_blank" rel="external">Promise.all</a> æ–¹æ³•ã€‚åƒ â€¦ è¿™æ ·çš„ç®€æ´ï¼Œå¥½å§ï¼Œæˆ‘æƒ³ä¸å‡ºæ¥ä¾‹å­äº†ğŸ˜ã€‚</p>
<p>åœ¨ä¼ªç®—æ³•ä¸­ï¼Œ<code>Promise.all</code> å¯ä»¥è¢«æ¦‚æ‹¬ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">æ¥æ”¶ä¸€ä¸ª Promise æ•°ç»„</div><div class="line"></div><div class="line">    ç„¶ååŒæ—¶è¿è¡Œä»–ä»¬</div><div class="line"></div><div class="line">    ç„¶åç­‰åˆ°ä»–ä»¬å…¨éƒ¨è¿è¡Œå®Œæˆ</div><div class="line"></div><div class="line">    ç„¶å return ä¸€ä¸ªæ–°çš„ Promise æ•°ç»„</div><div class="line"></div><div class="line">    ä»–ä»¬å…¶ä¸­æœ‰ä¸€ä¸ªå¤±è´¥æˆ–è€… rejectï¼Œéƒ½å¯ä»¥è¢«æ•è·ã€‚</div></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†æ‰€æœ‰çš„ Promise å®Œæˆçš„æƒ…å†µï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">var prom1 = Promise.resolve(5);</div><div class="line">var prom2 = fetchServerStatus(); // è¿”å› &#123;statusCode: 200&#125; çš„ Promise</div><div class="line"></div><div class="line">Proimise.all([prom1, prom2])</div><div class="line">.then([val1, val2] =&gt; &#123; // æ³¨æ„ï¼Œè¿™é‡Œè¢«è§£ææˆä¸€ä¸ªæ•°ç»„</div><div class="line">    console.log(val1); // 5</div><div class="line">    console.log(val2.statusCode); // 200</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å½“ä»–ä»¬å…¶ä¸­ä¸€ä¸ªå¤±è´¥çš„æƒ…å†µï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var prom1 = Promise.reject(5);</div><div class="line">var prom2 = fetchServerStatus(); // è¿”å› &#123;statusCode: 200&#125; çš„ Promise</div><div class="line"></div><div class="line">Proimise.all([prom1, prom2])</div><div class="line">.then([val1, val2] =&gt; &#123;</div><div class="line">    console.log(val1); </div><div class="line">    console.log(val2.statusCode); </div><div class="line">&#125;)</div><div class="line">.catch(e =&gt;  console.log(e)) // 5, ç›´æ¥è·³è½¬åˆ° .catch</div></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼š<code>Promise.all</code> æ˜¯å¾ˆèªæ˜çš„ï¼å¦‚æœå…¶ä¸­ä¸€ä¸ª Promise å¤±è´¥äº†ï¼Œå®ƒä¸ä¼šç­‰åˆ°æ‰€æœ‰çš„ Promise å®Œæˆï¼Œè€Œæ˜¯ç«‹å³ä¸­æ­¢ï¼</strong></p>
<h2 id="8-ä¸è¦å®³æ€•-rejectï¼Œä¹Ÿä¸è¦åœ¨æ¯ä¸ª-then-åé¢åŠ å†—ä½™çš„-catch"><a href="#8-ä¸è¦å®³æ€•-rejectï¼Œä¹Ÿä¸è¦åœ¨æ¯ä¸ª-then-åé¢åŠ å†—ä½™çš„-catch" class="headerlink" title="8. ä¸è¦å®³æ€• rejectï¼Œä¹Ÿä¸è¦åœ¨æ¯ä¸ª .then åé¢åŠ å†—ä½™çš„ .catch"></a>8. ä¸è¦å®³æ€• rejectï¼Œä¹Ÿä¸è¦åœ¨æ¯ä¸ª .then åé¢åŠ å†—ä½™çš„ <code>.catch</code></h2><p>æˆ‘ä»¬æ˜¯ä¸æ˜¯ä¼šç»å¸¸æ‹…å¿ƒé”™è¯¯ä¼šåœ¨å®ƒä»¬ä¹‹é—´çš„æŸå¤„è¢«åå™¬ï¼Ÿ</p>
<p>ä¸ºäº†å…‹æœè¿™ä¸ªææƒ§ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„å°æç¤ºï¼š</p>
<blockquote>
<p><strong>è®© reject æ¥å¤„ç†ä¸Šæ¸¸å‡½æ•°çš„é—®é¢˜ã€‚</strong></p>
</blockquote>
<p>åœ¨ç†æƒ³çš„æƒ…å†µä¸‹ï¼Œreject æ–¹æ³•åº”è¯¥æ˜¯åº”ç”¨çš„æ ¹æºï¼Œæ‰€æœ‰çš„ reject éƒ½ä¼šå‘ä¸‹ä¼ é€’ã€‚</p>
<p><strong>ä¸è¦å®³æ€•åƒä¸‹é¢è¿™æ ·å†™</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">return fetchSomeData(...);</div></pre></td></tr></table></figure>
<p>ç°åœ¨å¦‚æœä½ æƒ³è¦å¤„ç†å‡½æ•°ä¸­ reject çš„æƒ…å†µï¼Œè¯·å†³å®šæ˜¯è§£å†³é—®é¢˜è¿˜æ˜¯ç»§ç»­ rejectã€‚</p>
<p>ğŸ’˜ <strong>è§£å†³ reject</strong></p>
<p>è§£å†³ reject æ˜¯å¾ˆç®€å•çš„ï¼Œåœ¨ <code>.catch</code> ä¸è®ºä½ è¿”å›ä»€ä¹ˆå†…å®¹ï¼Œéƒ½å°†è¢«å‡å®šä¸ºå·²è§£å†³çš„ã€‚ç„¶è€Œï¼Œå¦‚æœä½ åœ¨ <code>.catch</code> ä¸­è¿”å› <code>Promise.reject</code>ï¼Œé‚£ä¹ˆè¿™ä¸ª Promise å°†ä¼šæ˜¯å¤±è´¥çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">.then(() =&gt; 5.length) // &lt;-- è¿™é‡Œä¼šæŠ¥é”™</div><div class="line">.catch(e =&gt; &#123;</div><div class="line">        return 5;  // &lt;-- é‡æ–°ä½¿æ–¹æ³•æ­£å¸¸è¿è¡Œ</div><div class="line">&#125;)</div><div class="line">.then(r =&gt; &#123;</div><div class="line">    console.log(r); // 5</div><div class="line">&#125;)</div><div class="line">.catch(e =&gt; &#123;</div><div class="line">    console.error(e); // è¿™ä¸ªæ–¹æ³•æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ :)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>ğŸ’”<strong>æ‹’ç»ä¸€ä¸ª reject</strong></p>
<p>æ‹’ç»ä¸€ä¸ª reject æ˜¯ç®€å•çš„ã€‚<strong>ä¸éœ€è¦åšä»»ä½•äº‹æƒ…ã€‚</strong> å°±åƒæˆ‘åˆšåˆšè¯´çš„ï¼Œè®©å®ƒæˆä¸ºå…¶ä»–å‡½æ•°çš„é—®é¢˜ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œçˆ¶å‡½æ•°æœ‰æ¯”å½“å‰å‡½æ•°å¤„ç† reject æ›´å¥½çš„æ–¹æ³•ã€‚</p>
<p>éœ€è¦è®°ä½çš„é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œä¸€æ—¦ä½ å†™äº† catch æ–¹æ³•ï¼Œå°±æ„å‘³ç€ä½ æ­£åœ¨å¤„ç†è¿™ä¸ªé”™è¯¯ã€‚è¿™ä¸ªå’ŒåŒæ­¥ <code>try/catch</code>çš„å·¥ä½œæ–¹å¼ç›¸ä¼¼ã€‚</p>
<p>å¦‚æœä½ ç¡®å®æƒ³è¦æ‹¦æˆªä¸€ä¸ª rejectï¼šï¼ˆæˆ‘å¼ºçƒˆå»ºè®®ä¸è¦è¿™æ ·åšï¼ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">.then(() =&gt; 5.length) // &lt;-- è¿™é‡Œä¼šæŠ¥é”™</div><div class="line">.catch(e =&gt; &#123;</div><div class="line">  errorLogger(e); // åšä¸€äº›é”™è¯¯å¤„ç†</div><div class="line">  return Promise.reject(e); // æ‹’ç»å®ƒï¼Œæ˜¯çš„ï¼Œä½ å¯ä»¥è¿™ä¹ˆåšï¼</div><div class="line">&#125;)</div><div class="line">.then(r =&gt; &#123;</div><div class="line">    console.log(r); // è¿™ä¸ª .then (æˆ–è€…ä»»ä½•åé¢çš„ .then) å°†æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸Šé¢ä½¿ç”¨äº† reject :)</div><div class="line">&#125;)</div><div class="line">.catch(e =&gt; &#123;</div><div class="line">    console.error(e); //&lt;-- å®ƒå˜æˆäº†è¿™ä¸ª catch æ–¹æ³•çš„é—®é¢˜</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><strong>.then(x,y) å’Œ then(x).catch(x) ä¹‹é—´çš„åˆ†ç•Œçº¿</strong></p>
<p><code>.then</code> æ¥æ”¶çš„ç¬¬äºŒä¸ªå›è°ƒå‡½æ•°å‚æ•°ä¹Ÿå¯ä»¥ç”¨æ¥å¤„ç†é”™è¯¯ã€‚å®ƒå’Œ <code>then(x).catch(x)</code> çœ‹èµ·æ¥å¾ˆåƒï¼Œä½†æ˜¯ä»–ä»¬å¤„ç†é”™è¯¯çš„åŒºåˆ«åœ¨äºä»–ä»¬è‡ªèº«æ•è·çš„é”™è¯¯ã€‚</p>
<p>æˆ‘ä¼šç”¨ä¸‹é¢çš„ä¾‹å­æ¥è¯´æ˜è¿™ä¸€ç‚¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">.then(function() &#123;</div><div class="line">   return Promise.reject(new Error(&apos;something wrong happened&apos;));</div><div class="line">&#125;).catch(function(e) &#123;</div><div class="line">   console.error(e); // something wrong happened</div><div class="line">&#125;);</div><div class="line"></div><div class="line">.then(function() &#123;</div><div class="line">   return Promise.reject(new Error(&apos;something wrong happened&apos;));</div><div class="line">&#125;, function(e) &#123; // è¿™ä¸ªå›è°ƒå¤„ç†æ¥è‡ªå½“å‰ `.then` æ–¹æ³•ä¹‹å‰çš„é”™è¯¯</div><div class="line">    console.error(e); // æ²¡æœ‰é”™è¯¯è¢«æ‰“å°å‡ºæ¥</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>å½“ä½ æƒ³è¦å¤„ç†çš„æ˜¯æ¥è‡ªä¸Šæ¸¸ Promise è€Œä¸æ˜¯åˆšåˆšåœ¨ <code>.then</code> é‡Œé¢åŠ ä¸Šå»çš„é”™è¯¯çš„æ—¶å€™ï¼Œ <code>.then(x,y)</code> å˜çš„å¾ˆæ–¹ä¾¿ã€‚</p>
<p>æç¤º: 99.9% çš„æƒ…å†µä½¿ç”¨ç®€å•çš„ <code>then(x).catch(x)</code> æ›´å¥½ã€‚</p>
<h2 id="9-é¿å…-then-å›è°ƒåœ°ç‹±"><a href="#9-é¿å…-then-å›è°ƒåœ°ç‹±" class="headerlink" title="9. é¿å… .then å›è°ƒåœ°ç‹±"></a>9. é¿å… .then å›è°ƒåœ°ç‹±</h2><p>è¿™ä¸ªæç¤ºæ˜¯ç›¸å¯¹ç®€å•çš„ï¼Œå°½é‡é¿å… <code>.then</code> é‡ŒåŒ…å« <code>.then</code> æˆ–è€… <code>.catch</code>ã€‚ç›¸ä¿¡æˆ‘ï¼Œè¿™æ¯”ä½ æƒ³è±¡çš„æ›´å®¹æ˜“é¿å…ã€‚</p>
<p>â˜ ï¸<strong>é”™è¯¯çš„</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">request(opts)</div><div class="line">.catch(err =&gt; &#123;</div><div class="line">  if (err.statusCode === 400) &#123;</div><div class="line">    return request(opts)</div><div class="line">           .then(r =&gt; r.text())</div><div class="line">           .catch(err2 =&gt; console.error(err2))</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>ğŸ’–<strong>æ­£ç¡®çš„</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">request(opts)</div><div class="line">.catch(err =&gt; &#123;</div><div class="line">  if (err.statusCode === 400) &#123;</div><div class="line">    return request(opts);</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line">.then(r =&gt; r.text())</div><div class="line">.catch(err =&gt; console.erro(err));</div></pre></td></tr></table></figure>
<p>æœ‰äº›æ—¶å€™æˆ‘ä»¬åœ¨ <code>.then</code> é‡Œé¢éœ€è¦å¾ˆå¤šå˜é‡ï¼Œé‚£å°±åˆ«æ— é€‰æ‹©äº†ï¼Œåªèƒ½å†åˆ›å»ºä¸€ä¸ª <code>.then</code> æ–¹æ³•é“¾ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.then(myVal =&gt; &#123;</div><div class="line">    const promA = foo(myVal);</div><div class="line">    const promB = anotherPromMake(myVal);</div><div class="line">    return promA</div><div class="line">          .then(valA =&gt; &#123;</div><div class="line">              return promB.then(valB =&gt; hungryFunc(valA, valB)); // å¾ˆä¸‘é™‹!</div><div class="line">          &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>æˆ‘æ¨èä½¿ç”¨ ES6 çš„è§£æ„æ–¹æ³•æ··åˆç€ <code>Promise.all</code> æ–¹æ³•å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">.then(myVal =&gt; &#123;</div><div class="line">    const promA = foo(myVal);</div><div class="line">    const promB = anotherPromMake(myVal);</div><div class="line">    return Promise.all([prom, anotherProm])</div><div class="line">&#125;)</div><div class="line">.then(([valA, valB]) =&gt; &#123;   // å¾ˆå¥½çš„ä½¿ç”¨ ES6 è§£æ„</div><div class="line">    console.log(valA, valB) // æ‰€æœ‰è§£æåçš„å€¼</div><div class="line">    return hungryFunc(valA, valB)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šå¦‚æœä½ çš„ node/æµè§ˆå™¨/è€æ¿/æ„è¯†å…è®¸ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function" target="_blank" rel="external">async/await</a> æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><strong>æˆ‘çœŸå¿ƒå¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹ä½ ç†è§£ Promise æœ‰æ‰€å¸®åŠ©ã€‚</strong></p>
<p>è¯·æŸ¥çœ‹æˆ‘ä¹‹å‰çš„åšå®¢æ–‡ç« ã€‚</p>
<ul>
<li><a href="https://dev.to/kepta/a-toddlers-guide-to-memory-leaks-in-javascript-25lf" target="_blank" rel="external">ä¸€ä¸ªåˆå­¦è€…æŒ‡å¯¼ Javascript å†…å­˜æ³„æ¼é—®é¢˜</a></li>
<li><a href="https://dev.to/kepta/understanding-default-parameters-in-javascript-ali" target="_blank" rel="external">äº†è§£ Javascript ä¸­çš„é»˜è®¤å‚æ•°</a></li>
</ul>
<p>å¦‚æœä½  â¤ï¸ è¿™ç¯‡æ–‡ç« ï¼Œè¯·åˆ†äº«è¿™ç¯‡æ–‡ç« æ¥ä¼ æ’­å®ƒã€‚</p>
<p>åœ¨ Twitter ä¸Šè”ç³»æˆ‘ <a href="https://twitter.com/kushan2020" target="_blank" rel="external">@kushan2020</a>ã€‚</p>
<hr>
<blockquote>
<p><a href="https://github.com/xitu/gold-miner" target="_blank" rel="external">æ˜é‡‘ç¿»è¯‘è®¡åˆ’</a> æ˜¯ä¸€ä¸ªç¿»è¯‘ä¼˜è´¨äº’è”ç½‘æŠ€æœ¯æ–‡ç« çš„ç¤¾åŒºï¼Œæ–‡ç« æ¥æºä¸º <a href="https://juejin.im" target="_blank" rel="external">æ˜é‡‘</a> ä¸Šçš„è‹±æ–‡åˆ†äº«æ–‡ç« ã€‚å†…å®¹è¦†ç›– <a href="https://github.com/xitu/gold-miner#android" target="_blank" rel="external">Android</a>ã€<a href="https://github.com/xitu/gold-miner#ios" target="_blank" rel="external">iOS</a>ã€<a href="https://github.com/xitu/gold-miner#å‰ç«¯" target="_blank" rel="external">å‰ç«¯</a>ã€<a href="https://github.com/xitu/gold-miner#åç«¯" target="_blank" rel="external">åç«¯</a>ã€<a href="https://github.com/xitu/gold-miner#åŒºå—é“¾" target="_blank" rel="external">åŒºå—é“¾</a>ã€<a href="https://github.com/xitu/gold-miner#äº§å“" target="_blank" rel="external">äº§å“</a>ã€<a href="https://github.com/xitu/gold-miner#è®¾è®¡" target="_blank" rel="external">è®¾è®¡</a>ã€<a href="https://github.com/xitu/gold-miner#äººå·¥æ™ºèƒ½" target="_blank" rel="external">äººå·¥æ™ºèƒ½</a>ç­‰é¢†åŸŸï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šä¼˜è´¨è¯‘æ–‡è¯·æŒç»­å…³æ³¨ <a href="https://github.com/xitu/gold-miner" target="_blank" rel="external">æ˜é‡‘ç¿»è¯‘è®¡åˆ’</a>ã€<a href="http://weibo.com/juejinfanyi" target="_blank" rel="external">å®˜æ–¹å¾®åš</a>ã€<a href="https://zhuanlan.zhihu.com/juejinfanyi" target="_blank" rel="external">çŸ¥ä¹ä¸“æ </a>ã€‚</p>
</blockquote>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>æ”¯æŒåŸåˆ›</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="http://oux6kzfrp.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1.jpeg" alt="Meng Yan WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="http://oux6kzfrp.bkt.clouddn.com/%E6%94%AF%E4%BB%98%E5%AE%9D%E4%BA%8C%E7%BB%B4%E7%A0%81.jpeg" alt="Meng Yan Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ç¿»è¯‘/" rel="tag"># ç¿»è¯‘</a>
          
            <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
          
            <a href="/tags/Promise/" rel="tag"># Promise</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/07/react-native-run-ios/" rel="next" title="æ¢ç´¢ä¸€ä¸ª React Native åº”ç”¨æ˜¯å¦‚ä½•å¯åŠ¨çš„ â€” Ios ç¯‡">
                <i class="fa fa-chevron-left"></i> æ¢ç´¢ä¸€ä¸ª React Native åº”ç”¨æ˜¯å¦‚ä½•å¯åŠ¨çš„ â€” Ios ç¯‡
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/05/react-best-practices/" rel="prev" title="æœªéµå®ˆ react æœ€ä½³å®è·µè€Œå¼•å‘çš„ Bug">
                æœªéµå®ˆ react æœ€ä½³å®è·µè€Œå¼•å‘çš„ Bug <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://oux6kzfrp.bkt.clouddn.com/blog/avatarIMG_3716.JPG"
               alt="Meng Yan" />
          <p class="site-author-name" itemprop="name">Meng Yan</p>
           
              <p class="site-description motion-element" itemprop="description">å‰ç«¯ï¼ŒJavaScriptï¼ŒCSSï¼Œç”Ÿæ´»ï¼Œå°å¥³ç”Ÿ</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yanyixin" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.weibo.com/2863604000/profile?topnav=1&wvr=6" target="_blank" title="å¾®åš">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      å¾®åš
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/meng-meng-75-61-6/activities" target="_blank" title="çŸ¥ä¹">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      çŸ¥ä¹
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://juejin.im/user/57221ca41532bc00624a1d0a" target="_blank" title="æ˜é‡‘">
                  
                    <i class="fa fa-fw fa-angle-double-down"></i>
                  
                    
                      æ˜é‡‘
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#å…³äº-Promise-çš„-9-ä¸ªæç¤º"><span class="nav-number">1.</span> <span class="nav-text">å…³äº Promise çš„ 9 ä¸ªæç¤º</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-ä½ å¯ä»¥åœ¨-then-é‡Œé¢-return-ä¸€ä¸ª-Promise"><span class="nav-number">1.1.</span> <span class="nav-text">1. ä½ å¯ä»¥åœ¨ .then é‡Œé¢ return ä¸€ä¸ª Promise</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-æ¯æ¬¡æ‰§è¡Œ-then-çš„æ—¶å€™éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„-Promise"><span class="nav-number">1.2.</span> <span class="nav-text">2. æ¯æ¬¡æ‰§è¡Œ .then çš„æ—¶å€™éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ Promise</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-å¯¹è°ƒç”¨è€…æ¥è¯´ï¼ŒPromise-çš„-resolved-rejected-çŠ¶æ€æ˜¯å”¯ä¸€çš„"><span class="nav-number">1.3.</span> <span class="nav-text">3. å¯¹è°ƒç”¨è€…æ¥è¯´ï¼ŒPromise çš„ resolved/rejected çŠ¶æ€æ˜¯å”¯ä¸€çš„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Promise-æ„é€ å‡½æ•°ä¸æ˜¯è§£å†³æ–¹æ¡ˆ"><span class="nav-number">1.4.</span> <span class="nav-text">4. Promise æ„é€ å‡½æ•°ä¸æ˜¯è§£å†³æ–¹æ¡ˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-ä½¿ç”¨-Promise-resolve"><span class="nav-number">1.5.</span> <span class="nav-text">5. ä½¿ç”¨ Promise.resolve</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-ä½¿ç”¨-Promise-reject"><span class="nav-number">1.6.</span> <span class="nav-text">6.ä½¿ç”¨ Promise.reject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-ä½¿ç”¨-Promise-all"><span class="nav-number">1.7.</span> <span class="nav-text">7. ä½¿ç”¨ Promise.all</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-ä¸è¦å®³æ€•-rejectï¼Œä¹Ÿä¸è¦åœ¨æ¯ä¸ª-then-åé¢åŠ å†—ä½™çš„-catch"><span class="nav-number">1.8.</span> <span class="nav-text">8. ä¸è¦å®³æ€• rejectï¼Œä¹Ÿä¸è¦åœ¨æ¯ä¸ª .then åé¢åŠ å†—ä½™çš„ .catch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-é¿å…-then-å›è°ƒåœ°ç‹±"><span class="nav-number">1.9.</span> <span class="nav-text">9. é¿å… .then å›è°ƒåœ°ç‹±</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Meng Yan</span>

  
</div>


  <div class="powered-by">
    ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    ä¸»é¢˜ &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Pisces
    </a>
  </div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user">æœ¬ç«™è®¿å®¢æ•°</i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      äººæ¬¡
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye">æœ¬ç«™æ€»è®¿é—®é‡</i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      æ¬¡
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("IHTzpb0fC94ev9hG4fQa60fR-gzGzoHsz", "wkXHDvgJLdiWePOmQmfWorPf");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
